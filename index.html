<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zimam Pharma - Supply Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root { --primary-bg: #f8f9fa; --sidebar-bg: #212529; --accent-color: #0d6efd; }
        body { background-color: var(--primary-bg); font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; }
        
        /* Sidebar */
        .sidebar { min-height: 100vh; background: var(--sidebar-bg); color: #babbbc; transition: all 0.3s; }
        .sidebar .nav-link { color: #babbbc; padding: 15px 20px; font-weight: 500; border-left: 4px solid transparent; cursor: pointer; }
        .sidebar .nav-link:hover { color: #fff; background: rgba(255,255,255,0.05); }
        .sidebar .nav-link.active { color: #fff; background: rgba(13, 110, 253, 0.1); border-left-color: var(--accent-color); }
        .sidebar i { width: 25px; text-align: center; margin-right: 10px; }

        /* Dashboard Cards */
        .card { border: none; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.03); background: #fff; }
        .stat-card { padding: 25px; position: relative; overflow: hidden; }
        .stat-card .icon-box { width: 50px; height: 50px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 24px; margin-bottom: 15px; }
        .stat-card h3 { font-size: 28px; font-weight: 700; margin-bottom: 5px; color: #333; }
        .stat-card p { margin: 0; font-size: 14px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: #777; }
        
        /* User Bar */
        .user-bar { background: white; padding: 10px 20px; border-bottom: 1px solid #e9ecef; display: flex; justify-content: flex-end; align-items: center; margin-bottom: 20px; border-radius: 0 0 10px 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        .user-badge { background: #eef2f7; padding: 5px 15px; border-radius: 20px; color: #555; font-size: 0.9rem; font-weight: 600; }

        /* Colors */
        .bg-soft-primary { background-color: rgba(13, 110, 253, 0.1); color: #0d6efd; }
        .bg-soft-success { background-color: rgba(25, 135, 84, 0.1); color: #198754; }
        .bg-soft-danger { background-color: rgba(220, 53, 69, 0.1); color: #dc3545; }
        .bg-soft-warning { background-color: rgba(255, 193, 7, 0.1); color: #ffc107; }

        /* Print Styles */
        #printable-container { display: none; }
        @media print {
            body > * { display: none !important; }
            .modal, .modal-backdrop { display: none !important; }
            #printable-container { display: block !important; position: absolute; left: 0; top: 0; width: 100%; background: white; color: #000; padding: 20px; }
            .print-header { border-bottom: 2px solid #000; margin-bottom: 15px; padding-bottom: 10px; }
            .print-header h1 { font-size: 26px; font-weight: 800; margin: 0; text-transform: uppercase; }
            .print-table { width: 100%; border-collapse: collapse; margin-bottom: 10px; font-size: 12px; }
            .print-table th { border-bottom: 2px solid #000; text-align: left; padding: 6px; font-weight: bold; }
            .print-table td { border-bottom: 1px solid #ccc; padding: 6px; }
            .print-footer { margin-top: 30px; text-align: center; font-size: 10px; font-style: italic; }
        }

        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 9999; display: none; justify-content: center; align-items: center; flex-direction: column; }
    </style>
</head>
<body>

<div id="loader">
    <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div>
    <h5 class="mt-3 text-muted">Zimam Pharma...</h5>
</div>

<div id="printable-container"></div>

<div id="auth-section" class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-4">
            <div class="card p-5 mt-5 text-center">
                <i class="fas fa-clinic-medical fa-4x text-primary mb-3"></i>
                <h3>Zimam Pharma</h3>
                <p class="text-muted">Admin Login</p>
                <form id="login-form" class="text-start">
                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" id="login-email" class="form-control" required>
                    </div>
                    <div class="mb-4">
                        <label class="form-label">Password</label>
                        <input type="password" id="login-password" class="form-control" required>
                    </div>
                    <button type="submit" class="btn btn-primary w-100 fw-bold">Login</button>
                    
                    <div class="text-center mt-4">
                        <small class="text-muted" style="font-size: 0.8rem;">Developed By <strong>Foyaz Chowdhury</strong></small>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div id="app-section" class="container-fluid d-none">
    <div class="row">
        <div class="col-md-2 sidebar p-0 d-print-none">
            <div class="p-4 border-bottom border-secondary">
                <h5 class="mb-0 text-white"><i class="fas fa-pills me-2"></i>Zimam Pharma</h5>
            </div>
            <ul class="nav flex-column mt-3">
                <li class="nav-item"><a class="nav-link active" onclick="showTab('dashboard')"><i class="fas fa-th-large"></i> Dashboard</a></li>
                <li class="nav-item"><a class="nav-link" onclick="showTab('new-invoice')"><i class="fas fa-file-invoice-dollar"></i> New Invoice</a></li>
                <li class="nav-item"><a class="nav-link" onclick="showTab('inventory')"><i class="fas fa-boxes"></i> Inventory</a></li>
                <li class="nav-item"><a class="nav-link" onclick="showTab('saved-invoices')"><i class="fas fa-history"></i> Saved Invoices</a></li>
                <li class="nav-item"><a class="nav-link" onclick="showTab('expenses')"><i class="fas fa-wallet"></i> Expenses</a></li>
                <li class="nav-item"><a class="nav-link" onclick="showTab('statement')"><i class="fas fa-chart-line"></i> Statement</a></li>
                <li class="nav-item"><a class="nav-link" onclick="showTab('settings')"><i class="fas fa-cog"></i> Settings</a></li>
                <li class="nav-item mt-5"><a class="nav-link text-danger" id="logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
            </ul>
        </div>

        <div class="col-md-10" style="height: 100vh; overflow-y: auto; background-color: #f4f6f9;">
            
            <div class="user-bar">
                <div class="user-badge">
                    <i class="fas fa-user-circle me-2 text-primary"></i>
                    Logged in as: <span id="user-email-display">...</span>
                </div>
            </div>

            <div class="p-4">
                <div id="dashboard" class="content-tab">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h3>Dashboard Overview</h3>
                        <button class="btn btn-outline-dark" onclick="triggerDashboardLoad()"><i class="fas fa-sync-alt"></i> Refresh</button>
                    </div>
                    <div class="row g-4 mb-4">
                        <div class="col-md-3"><div class="card stat-card"><div class="icon-box bg-soft-primary"><i class="fas fa-coins"></i></div><h3 id="dash-revenue">0.00</h3><p>Revenue</p></div></div>
                        <div class="col-md-3"><div class="card stat-card"><div class="icon-box bg-soft-success"><i class="fas fa-chart-line"></i></div><h3 id="dash-net-profit">0.00</h3><p>Net Profit</p></div></div>
                        <div class="col-md-3"><div class="card stat-card"><div class="icon-box bg-soft-danger"><i class="fas fa-hand-holding-usd"></i></div><h3 id="dash-due">0.00</h3><p>Total Due</p></div></div>
                        <div class="col-md-3"><div class="card stat-card"><div class="icon-box bg-soft-warning"><i class="fas fa-wallet"></i></div><h3 id="dash-expense">0.00</h3><p>Expenses</p></div></div>
                    </div>
                    <div class="row">
                        <div class="col-md-8">
                            <div class="card p-4">
                                <h5>Financial Breakdown</h5><hr>
                                <table class="table table-borderless">
                                    <tr><td>Total Sales</td><td class="text-end fw-bold" id="logic-sales">0.00</td></tr>
                                    <tr><td>- Cost of Goods</td><td class="text-end text-muted" id="logic-cogs">0.00</td></tr>
                                    <tr class="border-top"><td>= Gross Profit</td><td class="text-end fw-bold text-primary" id="logic-gross">0.00</td></tr>
                                    <tr><td>- Expenses</td><td class="text-end text-danger" id="logic-exp">0.00</td></tr>
                                    <tr class="border-top border-2"><td>= NET PROFIT</td><td class="text-end fw-bold text-success fs-5" id="logic-net">0.00</td></tr>
                                </table>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card p-4 bg-primary text-white text-center">
                                <i class="fas fa-server fa-3x mb-3"></i>
                                <h4>System Status</h4>
                                <div class="text-start mt-3 p-2 bg-dark bg-opacity-25 rounded" style="font-size:0.9rem">
                                    <p class="mb-1">Invoices Scanned: <strong id="debug-inv-count">0</strong></p>
                                    <p class="mb-1">Expenses Scanned: <strong id="debug-exp-count">0</strong></p>
                                    <p class="mb-0">Status: <strong id="debug-status" class="text-success">Checking...</strong></p>
                                </div>
                                <button class="btn btn-light text-primary fw-bold mt-3 w-100" onclick="backupData()">Download Backup</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="new-invoice" class="content-tab d-none">
                    <h3>New Invoice</h3><hr>
                    <div class="card p-4">
                        <div class="row mb-3"><div class="col-12"><input type="text" id="inv-shop" class="form-control" placeholder="Shop Name"></div></div>
                        <div class="row bg-light p-3 rounded align-items-end g-2">
                            <div class="col-md-4">
                                <input type="text" id="inv-item" class="form-control" placeholder="Item Name">
                                <select id="inv-item-helper" class="form-select mt-1" onchange="document.getElementById('inv-item').value=this.value"><option selected disabled>Select from Inventory</option></select>
                            </div>
                            <div class="col-md-2"><input type="number" id="inv-qty" class="form-control" placeholder="Qty"></div>
                            <div class="col-md-3"><input type="number" step="0.01" id="inv-buy-rate" class="form-control" placeholder="Buy Rate"></div>
                            <div class="col-md-3"><button class="btn btn-secondary w-100" onclick="addItemToDraft()">Add Item</button></div>
                        </div>
                        <div class="table-responsive mt-4"><table class="table table-bordered"><thead class="table-light"><tr><th>Item</th><th>Qty</th><th>Buy</th><th>Subtotal</th><th>Action</th></tr></thead><tbody id="temp-invoice-body"></tbody></table></div>
                        <div class="text-end mt-2"><button class="btn btn-primary" onclick="saveDraftInvoice()">Save Draft</button></div>
                    </div>
                    <h4 class="mt-5">Drafts</h4>
                    <div class="table-responsive"><table class="table table-hover bg-white shadow-sm"><thead class="table-dark"><tr><th>Date</th><th>Shop</th><th>Items</th><th>Action</th></tr></thead><tbody id="drafts-table-body"></tbody></table></div>
                </div>

                <div id="inventory" class="content-tab d-none">
                    <h3>Inventory</h3><hr>
                    <div class="card p-3 bg-light mb-4">
                        <div class="row g-2 align-items-end"><div class="col-9"><input type="text" id="manual-inv-name" class="form-control" placeholder="New Medicine Name"></div><div class="col-3"><button onclick="addManualInventory()" class="btn btn-success w-100">Add</button></div></div>
                    </div>
                    <input type="text" id="inventory-search" onkeyup="filterInventory()" class="form-control mb-3" placeholder="Search...">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover bg-white">
                            <thead class="table-dark"><tr><th>Item Name</th><th>Status</th><th>Action</th></tr></thead>
                            <tbody id="inventory-table-body"></tbody>
                        </table>
                    </div>
                </div>

                <div id="saved-invoices" class="content-tab d-none">
                    <h3>Saved Invoices</h3><hr>
                    <input type="text" id="search-invoice" class="form-control mb-3" placeholder="Search..." onkeyup="filterSavedInvoices()">
                    <div class="table-responsive"><table class="table table-striped bg-white shadow-sm align-middle"><thead class="table-dark"><tr><th>Inv #</th><th>Date</th><th>Shop</th><th>Total</th><th class="text-success">Paid</th><th class="text-danger">Due</th><th>Action</th></tr></thead><tbody id="saved-invoices-body"></tbody></table></div>
                </div>

                <div id="expenses" class="content-tab d-none">
                    <h3>Expenses</h3><hr>
                    <div class="card p-3 mb-4">
                        <div class="row g-3">
                            <div class="col-md-6"><input type="text" id="exp-desc" class="form-control" placeholder="Description"></div>
                            <div class="col-md-4"><input type="number" id="exp-amount" class="form-control" placeholder="Amount"></div>
                            <div class="col-md-2"><button type="button" onclick="window.saveExpense()" class="btn btn-danger w-100">Add</button></div>
                        </div>
                    </div>
                    <table class="table bg-white"><tbody id="expense-list"></tbody></table>
                </div>

                <div id="statement" class="content-tab d-none">
                    <h3>Statement</h3><hr>
                    <div class="card p-3 mb-4"><div class="row g-3 align-items-end"><div class="col-md-4"><label>Start</label><input type="date" id="st-start" class="form-control"></div><div class="col-md-4"><label>End</label><input type="date" id="st-end" class="form-control"></div><div class="col-md-4"><button onclick="generateStatement()" class="btn btn-primary w-100">Generate</button></div></div></div>
                    <div id="statement-result" class="d-none"><div class="row text-center mb-3"><div class="col-md-4"><div class="alert alert-success">Sales: <strong id="st-sales">0</strong></div></div><div class="col-md-4"><div class="alert alert-warning">Exp: <strong id="st-expenses">0</strong></div></div><div class="col-md-4"><div class="alert alert-info">Net: <strong id="st-profit">0</strong></div></div></div><table class="table table-bordered bg-white"><tbody id="st-table"></tbody></table></div>
                </div>

                <div id="settings" class="content-tab d-none">
                    <h3>Settings</h3><hr>
                    <div id="settings-lock" class="text-center p-5 bg-white shadow-sm"><h4>Restricted</h4><button class="btn btn-dark mt-2" onclick="requestAuth('settings')">Unlock</button></div>
                    <div id="settings-content" class="d-none"><div class="row"><div class="col-md-7"><div class="card p-4"><form id="org-settings-form"><div class="mb-3"><label>Name</label><input type="text" id="set-name" class="form-control"></div><div class="mb-3"><label>Address</label><input type="text" id="set-address" class="form-control"></div><div class="row"><div class="col-6"><input type="text" id="set-phone" class="form-control"></div><div class="col-6"><input type="email" id="set-email" class="form-control"></div></div><div class="mt-3"><textarea id="set-footer" class="form-control"></textarea></div><button type="submit" class="btn btn-success mt-3">Save</button></form></div></div><div class="col-md-5"><div class="card p-4 border-danger"><h5 class="text-danger">Danger Zone</h5><button onclick="requestAuth('reset')" class="btn btn-danger w-100 mt-2">Factory Reset</button></div><div class="card p-4 mt-3"><button onclick="backupData()" class="btn btn-outline-primary w-100 mb-3">Backup Data</button><div class="input-group"><input type="file" id="import-file" class="form-control"><button class="btn btn-primary" onclick="importData()">Import</button></div></div></div></div></div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="paymentModal" tabindex="-1"><div class="modal-dialog modal-sm"><div class="modal-content"><div class="modal-header bg-success text-white"><h5 class="modal-title">Payment</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><h4 id="pay-inv-num" class="text-center"></h4><div class="d-flex justify-content-between"><span>Due:</span><strong id="pay-current-due" class="text-danger"></strong></div><input type="number" id="pay-amount" class="form-control mt-3" placeholder="Amount"><input type="hidden" id="pay-inv-id"><button class="btn btn-success w-100 mt-3" onclick="savePayment()">Save</button></div></div></div></div>

<div class="modal fade" id="finalizeModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white"><h5 class="modal-title">Finalize Invoice</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <h5 id="fin-shop-name"></h5>
                <table class="table table-bordered">
                    <thead class="table-light"><tr><th>Item</th><th>Qty</th><th>Buy</th><th>Sell</th><th>Total</th></tr></thead>
                    <tbody id="finalize-table-body"></tbody>
                    <tfoot><tr><td colspan="4" class="text-end fw-bold">Grand Total:</td><td id="fin-grand-total">0.00</td></tr></tfoot>
                </table>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button class="btn btn-primary" onclick="window.confirmFinalize()">Finalize & Save</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="authModal" tabindex="-1"><div class="modal-dialog modal-sm"><div class="modal-content"><div class="modal-header"><h5>Security</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><input type="password" id="auth-check-pass" class="form-control" placeholder="Password"><input type="hidden" id="auth-action-type"><input type="hidden" id="auth-action-id"></div><div class="modal-footer"><button class="btn btn-dark w-100" onclick="performAuthAction()">Verify</button></div></div></div></div>
<div class="modal fade" id="printModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header d-print-none"><h5 class="modal-title">Preview</h5><button class="btn btn-primary ms-auto" onclick="window.print()">Print</button></div><div class="modal-body" id="preview-area"></div></div></div></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, EmailAuthProvider, reauthenticateWithCredential } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, query, where, orderBy, getDoc, setDoc, increment } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

const firebaseConfig = { apiKey: "AIzaSyBv2cgBjOi-MMwS1xynPftCXI63uVEiRsk", authDomain: "zimam-pharma.firebaseapp.com", projectId: "zimam-pharma", storageBucket: "zimam-pharma.firebasestorage.app", messagingSenderId: "7955585226", appId: "1:7955585226:web:a18e625b47958d1b073c33", measurementId: "G-B6LHCTC9SE" };
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
let currentUser = null, currentDraftItems = [], finalizeItems = [], currentFinalizeId = null;

// Auth
document.getElementById('login-form').addEventListener('submit', (e) => { e.preventDefault(); toggleLoader(true); signInWithEmailAndPassword(auth, document.getElementById('login-email').value, document.getElementById('login-password').value).then(() => toggleLoader(false)).catch(err => { alert(err.message); toggleLoader(false); }); });
onAuthStateChanged(auth, (user) => {
    currentUser = user;
    if (user) {
        document.getElementById('auth-section').classList.add('d-none'); document.getElementById('app-section').classList.remove('d-none');
        document.getElementById('user-email-display').innerText = user.email; // SHOW EMAIL
        triggerDashboardLoad(); loadSettings(); loadInventory();
    } else {
        document.getElementById('auth-section').classList.remove('d-none'); document.getElementById('app-section').classList.add('d-none');
    }
});
document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));

window.showTab = (id) => {
    document.querySelectorAll('.content-tab').forEach(el => el.classList.add('d-none')); document.getElementById(id).classList.remove('d-none');
    if(id==='dashboard') triggerDashboardLoad(); if(id==='saved-invoices') loadSavedInvoices(); if(id==='new-invoice') loadDrafts(); if(id==='expenses') loadExpenses(); if(id==='inventory') loadInventory();
};

async function triggerDashboardLoad() {
    try {
        const debugStatus = document.getElementById('debug-status'); debugStatus.innerText = "Scanning..."; debugStatus.className = "text-warning";
        const invSnap = await getDocs(query(collection(db, "invoices"), where("status", "==", "final")));
        let rev=0, cogs=0, paid=0, invCount=0;
        invSnap.forEach(doc => {
            invCount++;
            const d = doc.data();
            let iTotal=0, iCost=0;
            if(d.items) d.items.forEach(i => { iTotal += (i.qty||0)*(i.sellingRate||0); iCost += (i.qty||0)*(i.purchaseRate||0); });
            rev += iTotal; cogs += iCost; paid += d.paidAmount||0;
        });
        let exp=0, expCount=0;
        try { const expSnap = await getDocs(collection(db, "expenses")); expSnap.forEach(d => { expCount++; exp += d.data().amount||0; }); } catch(err){console.error(err);}
        
        document.getElementById('dash-revenue').innerText = rev.toFixed(2);
        document.getElementById('dash-expense').innerText = exp.toFixed(2);
        document.getElementById('dash-net-profit').innerText = (rev - cogs - exp).toFixed(2);
        document.getElementById('dash-due').innerText = (rev - paid).toFixed(2);
        
        document.getElementById('logic-sales').innerText = rev.toFixed(2);
        document.getElementById('logic-cogs').innerText = "- " + cogs.toFixed(2);
        document.getElementById('logic-gross').innerText = (rev - cogs).toFixed(2);
        document.getElementById('logic-exp').innerText = "- " + exp.toFixed(2);
        document.getElementById('logic-net').innerText = (rev - cogs - exp).toFixed(2);
        
        document.getElementById('debug-inv-count').innerText = invCount;
        document.getElementById('debug-exp-count').innerText = expCount;
        debugStatus.innerText = "System Live"; debugStatus.className = "text-success fw-bold";
    } catch(e) { document.getElementById('debug-status').innerText = "Error"; }
}
window.triggerDashboardLoad = triggerDashboardLoad;

async function loadInventory() {
    const snap = await getDocs(collection(db, "inventory"));
    const list = document.getElementById('inv-item-helper'); const tbody = document.getElementById('inventory-table-body');
    list.innerHTML='<option selected disabled>Select from Inventory</option>'; tbody.innerHTML='';
    
    // Process items to array for sorting
    let items=[]; 
    snap.forEach(d => items.push({ id: d.id, ...d.data() }));
    items.sort((a, b) => a.name.localeCompare(b.name));

    items.forEach(n => {
        list.innerHTML += `<option value="${n.name}">${n.name}</option>`;
        tbody.innerHTML += `
        <tr>
            <td>${n.name}</td>
            <td><span class="badge bg-success">Active</span></td>
            <td><button class="btn btn-sm btn-outline-danger" onclick="requestAuth('delete_inventory', '${n.id}')"><i class="fas fa-trash"></i></button></td>
        </tr>`;
    });
}
window.addManualInventory = async () => {
    const n = document.getElementById('manual-inv-name').value.trim();
    if(n) { await addDoc(collection(db,"inventory"),{name:n}); document.getElementById('manual-inv-name').value=''; loadInventory(); alert("Saved"); }
};

window.addItemToDraft = () => {
    const i=document.getElementById('inv-item').value, q=parseFloat(document.getElementById('inv-qty').value), r=parseFloat(document.getElementById('inv-buy-rate').value);
    if(i && q && !isNaN(r)) { 
        currentDraftItems.push({item:i, qty:q, purchaseRate:r, subtotalBuy:q*r}); renderDraft(); 
        document.getElementById('inv-item').value=''; document.getElementById('inv-qty').value=''; document.getElementById('inv-buy-rate').value='';
    } else alert("Fill data");
};
function renderDraft(){ const tb=document.getElementById('temp-invoice-body'); tb.innerHTML=''; currentDraftItems.forEach((x,k)=>tb.innerHTML+=`<tr><td>${x.item}</td><td>${x.qty}</td><td>${x.purchaseRate}</td><td>${x.subtotalBuy}</td><td><button class="btn btn-sm btn-danger" onclick="currentDraftItems.splice(${k},1);renderDraft()">X</button></td></tr>`); }

window.saveDraftInvoice = async () => {
    const s=document.getElementById('inv-shop').value;
    if(s && currentDraftItems.length) { 
        await addDoc(collection(db,"invoices"), {shop:s, items:currentDraftItems, status:'draft', createdAt:new Date()});
        currentDraftItems=[]; renderDraft(); document.getElementById('inv-shop').value=''; loadDrafts(); alert("Draft Saved");
    } else alert("Fill data");
};

async function loadDrafts() {
    const snap = await getDocs(query(collection(db,"invoices"), where("status","==","draft")));
    const tb=document.getElementById('drafts-table-body'); tb.innerHTML='';
    let d=[]; snap.forEach(x=>d.push({id:x.id, ...x.data()})); d.sort((a,b)=>b.createdAt-a.createdAt);
    d.forEach(x=>{ tb.innerHTML+=`<tr><td>${x.createdAt.toDate().toLocaleDateString()}</td><td>${x.shop}</td><td>${x.items.length}</td><td><button class="btn btn-sm btn-primary" onclick="openFinalize('${x.id}','${x.shop}')">Finalize</button></td></tr>`; });
}

window.openFinalize = async (id, shop) => {
    currentFinalizeId=id; document.getElementById('fin-shop-name').innerText=shop;
    finalizeItems = (await getDoc(doc(db,"invoices",id))).data().items;
    renderFinalize(); new bootstrap.Modal(document.getElementById('finalizeModal')).show();
};

window.updateItemRate = (idx, val) => {
    finalizeItems[idx].sellingRate = parseFloat(val)||0;
    renderFinalize();
};

function renderFinalize(){ 
    const tb=document.getElementById('finalize-table-body'); tb.innerHTML=''; let t=0;
    finalizeItems.forEach((x,k)=>{ 
        const s=x.sellingRate||0; t+=x.qty*s;
        tb.innerHTML+=`<tr><td>${x.item}</td><td>${x.qty}</td><td>${x.purchaseRate}</td><td><input type="number" step="0.01" class="form-control form-control-sm" value="${s||''}" onchange="window.updateItemRate(${k}, this.value)"></td><td>${(x.qty*s).toFixed(2)}</td></tr>`;
    });
    document.getElementById('fin-grand-total').innerText=t.toFixed(2);
}

window.confirmFinalize = async () => {
    if(finalizeItems.some(x=>!x.sellingRate)) return alert("Enter all rates");
    toggleLoader(true);
    
    // SMART INVENTORY LOGIC
    const invSnap = await getDocs(collection(db, "inventory"));
    const existingNames = new Set();
    invSnap.forEach(d => existingNames.add(d.data().name.trim().toLowerCase()));

    for(const item of finalizeItems) {
        const cleanName = item.item.trim();
        if (!existingNames.has(cleanName.toLowerCase())) {
            await addDoc(collection(db, "inventory"), { name: cleanName });
            existingNames.add(cleanName.toLowerCase()); // Add to set to prevent dupes in same invoice
        }
    }

    await updateDoc(doc(db,"invoices",currentFinalizeId), {status:'final', items:finalizeItems, finalizedAt:new Date(), invoiceNum:"INV-"+Date.now().toString().slice(-6), paidAmount:0});
    bootstrap.Modal.getInstance(document.getElementById('finalizeModal')).hide();
    loadDrafts(); loadInventory(); triggerDashboardLoad(); toggleLoader(false); alert("Finalized");
};

async function loadSavedInvoices() {
    const snap = await getDocs(query(collection(db,"invoices"), where("status","==","final")));
    const tb=document.getElementById('saved-invoices-body'); tb.innerHTML='';
    let d=[]; snap.forEach(x=>d.push({id:x.id, ...x.data()})); d.sort((a,b)=>b.finalizedAt-a.finalizedAt);
    d.forEach(x=>{
        let t=0; x.items.forEach(i=>t+=i.qty*i.sellingRate); const p=x.paidAmount||0;
        tb.innerHTML+=`
        <tr class="inv-row">
            <td>${x.invoiceNum}</td>
            <td>${x.finalizedAt.toDate().toLocaleDateString()}</td>
            <td>${x.shop}</td>
            <td>${t.toFixed(2)}</td>
            <td class="text-success">${p.toFixed(2)}</td>
            <td class="text-danger fw-bold">${(t-p).toFixed(2)}</td>
            <td>
                <button class="btn btn-sm btn-info" onclick="printView('${x.id}')"><i class="fas fa-print"></i></button> 
                <button class="btn btn-sm btn-success" onclick="openPay('${x.id}','${x.invoiceNum}',${t-p})"><i class="fas fa-dollar-sign"></i></button>
                <button class="btn btn-sm btn-danger" onclick="requestAuth('delete_invoice', '${x.id}')"><i class="fas fa-trash"></i></button>
            </td>
        </tr>`;
    });
}

window.openPay = (id,n,d) => { document.getElementById('pay-inv-id').value=id; document.getElementById('pay-inv-num').innerText=n; document.getElementById('pay-current-due').innerText=d.toFixed(2); new bootstrap.Modal(document.getElementById('paymentModal')).show(); };
window.savePayment = async () => {
    const id=document.getElementById('pay-inv-id').value, a=parseFloat(document.getElementById('pay-amount').value);
    if(a>0) { await updateDoc(doc(db,"invoices",id),{paidAmount:increment(a)}); bootstrap.Modal.getInstance(document.getElementById('paymentModal')).hide(); loadSavedInvoices(); triggerDashboardLoad(); }
};

window.saveExpense = async () => {
    const d=document.getElementById('exp-desc').value, a=parseFloat(document.getElementById('exp-amount').value);
    if(d && a) { await addDoc(collection(db,"expenses"),{description:d, amount:a, date:new Date()}); document.getElementById('exp-desc').value=''; document.getElementById('exp-amount').value=''; loadExpenses(); triggerDashboardLoad(); alert("Saved"); }
    else alert("Fill all");
};
async function loadExpenses() {
    const snap = await getDocs(query(collection(db,"expenses"), orderBy("date","desc")));
    const tb=document.getElementById('expense-list'); tb.innerHTML='';
    snap.forEach(d=>tb.innerHTML+=`
    <tr>
        <td>${d.data().date.toDate().toLocaleDateString()}</td>
        <td>${d.data().description}</td>
        <td>${d.data().amount}</td>
        <td><button class="btn btn-sm btn-outline-danger" onclick="requestAuth('delete_expense', '${d.id}')"><i class="fas fa-trash"></i></button></td>
    </tr>`);
}

window.printView = async (id) => {
    const d=(await getDoc(doc(db,"invoices",id))).data();
    const s=(await getDoc(doc(db,"settings","config"))).data()||{name:"Zimam Pharma"};
    let r='', t=0; d.items.forEach(i=>{t+=i.qty*i.sellingRate; r+=`<tr><td>${i.item}</td><td>${i.qty}</td><td>${i.sellingRate}</td><td>${(i.qty*i.sellingRate).toFixed(2)}</td></tr>`;});
    document.getElementById('preview-area').innerHTML=`<div class="p-3 border"><h3>${s.name}</h3><p>${s.address||''}</p><hr><h5>Bill To: ${d.shop}</h5><table class="table table-sm"><thead><tr><th>Item</th><th>Qty</th><th>Rate</th><th>Total</th></tr></thead><tbody>${r}</tbody></table><h4 class="text-end">Total: ${t.toFixed(2)}</h4></div>`;
    document.getElementById('printable-container').innerHTML=document.getElementById('preview-area').innerHTML;
    new bootstrap.Modal(document.getElementById('printModal')).show();
};

window.generateStatement = async () => {
    const s=new Date(document.getElementById('st-start').value), e=new Date(document.getElementById('st-end').value); e.setHours(23,59,59);
    const inv=await getDocs(query(collection(db,"invoices"),where("status","==","final"))), exp=await getDocs(query(collection(db,"expenses"),where("date",">=",s),where("date","<=",e)));
    let ts=0, te=0, h='';
    inv.forEach(d=>{ const x=d.data(); if(x.finalizedAt.toDate()>=s && x.finalizedAt.toDate()<=e){ let t=0;x.items.forEach(i=>t+=i.qty*i.sellingRate); ts+=t; h+=`<tr><td>${x.finalizedAt.toDate().toLocaleDateString()}</td><td>Sale: ${x.shop}</td><td>${t.toFixed(2)}</td></tr>`; }});
    exp.forEach(d=>{ te+=d.data().amount; h+=`<tr><td>${d.data().date.toDate().toLocaleDateString()}</td><td>Exp: ${d.data().description}</td><td>-${d.data().amount}</td></tr>`; });
    document.getElementById('st-sales').innerText=ts.toFixed(2); document.getElementById('st-expenses').innerText=te.toFixed(2); document.getElementById('st-profit').innerText=(ts-te).toFixed(2); document.getElementById('st-table').innerHTML=h; document.getElementById('statement-result').classList.remove('d-none');
};

async function loadSettings() { const d=(await getDoc(doc(db,"settings","config"))).data(); if(d){document.getElementById('set-name').value=d.name||''; document.getElementById('set-address').value=d.address||''; document.getElementById('set-phone').value=d.phone||''; document.getElementById('set-email').value=d.email||''; document.getElementById('set-footer').value=d.footer||'';}}
document.getElementById('org-settings-form').addEventListener('submit',async(e)=>{e.preventDefault(); await setDoc(doc(db,"settings","config"),{name:document.getElementById('set-name').value, address:document.getElementById('set-address').value, phone:document.getElementById('set-phone').value, email:document.getElementById('set-email').value, footer:document.getElementById('set-footer').value}); alert("Saved");});

window.backupData = async () => { const i=[],e=[],n=[]; (await getDocs(collection(db,"invoices"))).forEach(d=>i.push(d.data())); (await getDocs(collection(db,"expenses"))).forEach(d=>e.push(d.data())); (await getDocs(collection(db,"inventory"))).forEach(d=>n.push(d.data())); const b=new Blob([JSON.stringify({invoices:i,expenses:e,inventory:n})],{type:"application/json"}); const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download="backup.json"; a.click(); };
window.importData = () => { const f=document.getElementById('import-file').files[0]; const r=new FileReader(); r.onload=async(e)=>{ const d=JSON.parse(e.target.result); if(d.invoices)for(const i of d.invoices)await addDoc(collection(db,"invoices"),{...i,createdAt:new Date(i.createdAt),finalizedAt:new Date(i.finalizedAt)}); if(d.expenses)for(const i of d.expenses)await addDoc(collection(db,"expenses"),{...i,date:new Date(i.date)}); if(d.inventory)for(const i of d.inventory)await addDoc(collection(db,"inventory"),i); alert("Imported"); location.reload(); }; r.readAsText(f); };

// Security
window.requestAuth = (t,id) => { document.getElementById('auth-action-type').value=t; document.getElementById('auth-action-id').value=id||''; new bootstrap.Modal(document.getElementById('authModal')).show(); };
window.performAuthAction = async () => { 
    try { 
        await reauthenticateWithCredential(currentUser, EmailAuthProvider.credential(currentUser.email, document.getElementById('auth-check-pass').value)); 
        const t=document.getElementById('auth-action-type').value; 
        const id=document.getElementById('auth-action-id').value; 
        bootstrap.Modal.getInstance(document.getElementById('authModal')).hide(); 
        
        if(t==='settings'){document.getElementById('settings-lock').classList.add('d-none');document.getElementById('settings-content').classList.remove('d-none');}
        
        if(t==='delete_invoice') {
            await deleteDoc(doc(db, "invoices", id));
            loadSavedInvoices(); triggerDashboardLoad();
            alert("Invoice Deleted");
        }
        
        if(t==='delete_expense') {
            await deleteDoc(doc(db, "expenses", id));
            loadExpenses(); triggerDashboardLoad();
            alert("Expense Deleted");
        }

        if(t==='delete_inventory') {
            await deleteDoc(doc(db, "inventory", id));
            loadInventory();
            alert("Item Deleted from Inventory");
        }

        if(t==='reset') {
            toggleLoader(true);
            const inv = await getDocs(collection(db, "invoices")); inv.forEach(d => deleteDoc(d.ref));
            const exp = await getDocs(collection(db, "expenses")); exp.forEach(d => deleteDoc(d.ref));
            const items = await getDocs(collection(db, "inventory")); items.forEach(d => deleteDoc(d.ref));
            alert("Factory Reset Complete"); location.reload();
        }

    } catch(e){ alert("Wrong Password or Error: " + e.message); } 
};

window.filterInventory = () => { const t=document.getElementById('inventory-search').value.toLowerCase(); document.querySelectorAll('#inventory-table-body tr').forEach(r=>r.style.display=r.innerText.toLowerCase().includes(t)?'':'none'); };
window.filterSavedInvoices = () => { const t=document.getElementById('search-invoice').value.toLowerCase(); document.querySelectorAll('.inv-row').forEach(r=>r.style.display=r.innerText.toLowerCase().includes(t)?'':'none'); };
function toggleLoader(s){document.getElementById('loader').style.display=s?'flex':'none';}
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
